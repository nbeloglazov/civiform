#! /bin/bash

# DOC: Pull a tagged image from docker hub and upload it to ECR (default latest)

set -e
set +x

source bin/lib.sh

readonly CIVIFORM_ECR_ID="e4t4a0t0"
readonly TAG="latest"

echo "Building..."

docker build -f prod.Dockerfile \
  -t civiform:latest \
  --cache-from civiform/civiform:latest \
  --build-arg BUILDKIT_INLINE_CACHE=1 \
  --build-arg "image_tag=${SNAPSHOT_TAG}" \
  .

# log into AWS ECR for civiform/civiform
aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin "public.ecr.aws/${CIVIFORM_ECR_ID}"

# push the Docker Hub image to AWS ECR
docker tag civiform:latest "public.ecr.aws/${CIVIFORM_ECR_ID}/civiform/civiform:${TAG}"
docker push "public.ecr.aws/${CIVIFORM_ECR_ID}/civiform/civiform:${TAG}"
